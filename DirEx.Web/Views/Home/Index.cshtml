@using DirEx.Web.Keys
@using DirEx.Ldap.Data

@model LdapTree

@{
    ViewBag.Title = Model.Server;
}

<main>
	<section class="sidebar">
		@ShowTree(Model.Entries, true)
	</section>
	<section class="content">
		@Html.Partial("_Alerts")
		@if (Model.CurrentEntry != null)
		{
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title"><i class="fa fa-server">&nbsp;&nbsp;</i> @Model.CurrentEntry.RelativeName</h3>
				</div>
				<div class="panel-body">
					<dl class="dl-horizontal">
						@foreach (var attributeValue in Model.CurrentEntry.AttributeValues)
						{
							var isObjectClass = attributeValue.Item1.Equals("objectclass", StringComparison.OrdinalIgnoreCase);
							var isRdnComponent = Model.CurrentEntry.RelativeName.IndexOf(String.Format("{0}={1}", attributeValue.Item1, attributeValue.Item2), StringComparison.OrdinalIgnoreCase) >= 0;

							<dt class="@(isObjectClass ? "text-primary" : isRdnComponent ? "text-success" : "text-default")">@attributeValue.Item1</dt>
							<dd class="@(isObjectClass ? "text-info" : isRdnComponent ? "text-success" : "text-muted")">@attributeValue.Item2</dd>
						}
					</dl>
				</div>
			</div>
		}
	</section>
</main>

@helper ShowTree(ICollection<LdapEntry> entries, bool root = false)
{
	<ul class="list-group">
		@foreach (var entry in entries)
		{
			var entryExpands = entry.Entries.Any() && (root || (Request.Params[RequestParams.CurrentDn].EndsWith(entry.DistinguishedName)));
			var entrySelected = Request.Params.AllKeys.Contains(RequestParams.CurrentDn) && Request.Params[RequestParams.CurrentDn].Equals(entry.DistinguishedName);
			var itemClass = entrySelected ? "list-group-item-info" : String.Empty;
			var linkClass = entrySelected ? "active" : String.Empty;

			<li class="list-group-item @itemClass">
				@if (entryExpands)
				{
					<i class="fa fa-caret-down"></i>
				}
				else
				{
					<i class="fa fa-caret-right"></i>
				}
				@Html.ActionLink(entry.RelativeName, "index", new { currentDn = @entry.DistinguishedName }, new { @class = linkClass })
				@if (entryExpands)
				{
					@ShowTree(entry.Entries)
				}
			</li>
		}
	</ul>
}
